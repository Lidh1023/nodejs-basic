# LangGraph Agent å®Œå…¨æŒ‡å—

> ä»é›¶å¼€å§‹ï¼Œå½»åº•æŒæ¡ AI Agent çš„æ„å»ºä¹‹é“ â€”â€” è®© AI ä»ã€Œåªèƒ½è¯´ã€è¿›åŒ–åˆ°ã€Œèƒ½æ€è€ƒã€èƒ½è¡ŒåŠ¨ã€èƒ½è®°å¿†ã€

**æŠ€æœ¯æ ˆ**ï¼š[LangChain v0.3](https://js.langchain.com/) | [LangGraph v0.2](https://langchain-ai.github.io/langgraphjs/) | [Node.js 18+](https://nodejs.org/)

---

## ğŸš€ ä»£ç ä»“åº“ & è¿è¡Œç¯å¢ƒ

> ğŸ“¦ **æœ¬æ–‡æ‰€æœ‰ä»£ç ç¤ºä¾‹å‡å·²ä¸Šä¼  GitHubï¼Œè¯·æ”¾å¿ƒé£Ÿç”¨ï¼**

### GitHub ä»“åº“åœ°å€

ğŸ”— **[https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning](https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning)**

### è¿è¡Œç¯å¢ƒè¦æ±‚

```bash
# ç¯å¢ƒè¦æ±‚
Node.js >= 18.0.0
npm >= 9.0.0

# å…‹éš†ä»£ç 
git clone https://github.com/Lidh1023/nodejs-basic.git
cd nodejs-basic/langchain-learning

# å®‰è£…ä¾èµ–
npm install

# é…ç½®ç¯å¢ƒå˜é‡ï¼ˆåˆ›å»º .env æ–‡ä»¶ï¼‰
DEEPSEEK_API_KEY=your_api_key_here

# è¿è¡Œç¤ºä¾‹
node src/agent.js
```

### ä¾èµ–åŒ…ç‰ˆæœ¬

| åŒ…å                   | ç‰ˆæœ¬   | è¯´æ˜               |
| ---------------------- | ------ | ------------------ |
| `@langchain/langgraph` | ^0.2.x | LangGraph æ ¸å¿ƒåº“   |
| `@langchain/core`      | ^0.3.x | LangChain æ ¸å¿ƒç»„ä»¶ |
| `@langchain/deepseek`  | ^0.1.x | DeepSeek æ¨¡å‹æ”¯æŒ  |
| `zod`                  | ^3.x   | å‚æ•°æ ¡éªŒ           |
| `dotenv`               | ^16.x  | ç¯å¢ƒå˜é‡ç®¡ç†       |

> ğŸ’¡ **Tips**: æ‹‰å–ä»£ç åï¼Œåªéœ€é…ç½®å¥½ API Keyï¼Œå³å¯ç›´æ¥è¿è¡Œæ‰€æœ‰ç¤ºä¾‹ä»£ç ï¼

---

## ğŸ“– å†™åœ¨å‰é¢

**ä½ æ˜¯å¦æƒ³è¿‡è¿™äº›é—®é¢˜ï¼Ÿ**

- ğŸ¤” ä¸ºä»€ä¹ˆ ChatGPT åªèƒ½èŠå¤©ï¼Œä¸èƒ½å¸®æˆ‘çœŸæ­£åšäº‹ï¼Ÿ
- ğŸ¤” å¦‚ä½•è®© AI è‡ªå·±å†³å®šä»€ä¹ˆæ—¶å€™æŸ¥èµ„æ–™ã€ä»€ä¹ˆæ—¶å€™è®¡ç®—ï¼Ÿ
- ğŸ¤” AI Agent åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿå’Œæ™®é€šçš„ AI å¯¹è¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
- ğŸ¤” LangChain Agent å’Œ LangGraph åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ

**æœ¬æ–‡å°†å¸¦ä½ å½»åº•ç†è§£ Agent çš„æ¦‚å¿µã€åŸç†å’Œå®ç°ï¼**

è¯»å®Œæœ¬æ–‡ï¼Œä½ å°†èƒ½å¤Ÿï¼š

- âœ… ç†è§£ LangChain ä¸ LangGraph çš„å…³ç³»
- âœ… æŒæ¡ Agent çš„æœ¬è´¨å’Œå·¥ä½œåŸç†
- âœ… æŒæ¡ ReAct æ¨¡å¼ï¼ˆæ¨ç† + è¡ŒåŠ¨ï¼‰
- âœ… ä½¿ç”¨ LangGraph æ„å»ºè‡ªå·±çš„ Agent
- âœ… ä¸º Agent æ·»åŠ è®°å¿†åŠŸèƒ½ï¼Œå®ç°å¤šè½®å¯¹è¯
- âœ… ç†è§£ Agent ä¸ Tools çš„åä½œå…³ç³»

---

## ğŸ“š æ–‡ç« å¤§çº²

```
ğŸ“– Part 1: åŸºç¡€æ¦‚å¿µ
   â”œâ”€â”€ LangChain ä¸ LangGraph çš„å…³ç³»
   â”œâ”€â”€ ä»€ä¹ˆæ˜¯ Agent
   â””â”€â”€ Agent vs æ™®é€š LLM

ğŸ”„ Part 2: ReAct æ¨¡å¼
   â”œâ”€â”€ ReAct æ¨¡å¼è¯¦è§£
   â””â”€â”€ ReAct çš„æ ¸å¿ƒå¾ªç¯

ğŸ§© Part 3: Agent æ ¸å¿ƒç»„ä»¶
   â”œâ”€â”€ ç»„ä»¶æ¶æ„å›¾
   â”œâ”€â”€ LLMï¼ˆå¤§è„‘ï¼‰
   â”œâ”€â”€ Toolsï¼ˆå·¥å…·ï¼‰
   â”œâ”€â”€ Stateï¼ˆçŠ¶æ€ï¼‰
   â””â”€â”€ Graphï¼ˆæµç¨‹å›¾ï¼‰

ğŸ› ï¸ Part 4: æ„å»º Agent
   â”œâ”€â”€ ç¯å¢ƒå‡†å¤‡
   â”œâ”€â”€ å®Œæ•´ä»£ç ç¤ºä¾‹
   â””â”€â”€ Agent çš„å·¥ä½œæµç¨‹

ğŸ’¾ Part 5: è®°å¿†åŠŸèƒ½
   â”œâ”€â”€ ä¸ºä»€ä¹ˆéœ€è¦è®°å¿†
   â”œâ”€â”€ MemorySaver è¯¦è§£
   â””â”€â”€ thread_id çº¿ç¨‹æ ‡è¯†

ğŸ¯ Part 6: å®æˆ˜æ¡ˆä¾‹
   â”œâ”€â”€ å¤šè½®å¯¹è¯æœºå™¨äºº
   â”œâ”€â”€ å¸¦è®°å¿†çš„ Agent
   â””â”€â”€ æ™ºèƒ½å®¢æœ Agent

âœ… Part 7: æœ€ä½³å®è·µ

â“ Part 8: å¸¸è§é—®é¢˜ FAQ

ğŸš€ Part 9: è¿›é˜¶ä¸»é¢˜
```

---

# Part 1: åŸºç¡€æ¦‚å¿µ

## LangChain ä¸ LangGraph çš„å…³ç³»

> ğŸ’¡ **è¿™æ˜¯å¾ˆå¤šåˆå­¦è€…çš„å›°æƒ‘ç‚¹ï¼Œè®©æˆ‘ä»¬å…ˆæŠŠè¿™ä¸ªé—®é¢˜ææ¸…æ¥š**

### ä¸€å¥è¯å›ç­”

**Agent æ˜¯ä¸€ä¸ªé€šç”¨æ¦‚å¿µï¼Œä½†åœ¨ LangChain ç”Ÿæ€ä¸­ï¼Œæ„å»ºå¤æ‚ Agent çš„èƒ½åŠ›ä¸»è¦ç”± LangGraph æä¾›ã€‚**

### ä¸¤è€…çš„å®šä½åŒºåˆ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LangChain ç”Ÿæ€ç³»ç»Ÿ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    LangChain                             â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   ğŸ“¦ åŸºç¡€ç»„ä»¶åº“                                          â”‚   â”‚
â”‚   â”‚   â€¢ LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰                                    â”‚   â”‚
â”‚   â”‚   â€¢ Promptï¼ˆæç¤ºè¯æ¨¡æ¿ï¼‰                                 â”‚   â”‚
â”‚   â”‚   â€¢ Toolsï¼ˆå·¥å…·å®šä¹‰ï¼‰                                    â”‚   â”‚
â”‚   â”‚   â€¢ Memoryï¼ˆè®°å¿†ç»„ä»¶ï¼‰                                   â”‚   â”‚
â”‚   â”‚   â€¢ ç®€å•ç»„åˆï¼špipe()ã€RunnableSequence                   â”‚   â”‚
â”‚   â”‚   â€¢ ä¸»è¦å¤„ç†ï¼šçº¿æ€§æµç¨‹                                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    LangGraph                             â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   ğŸ”„ å·¥ä½œæµç¼–æ’æ¡†æ¶                                       â”‚   â”‚
â”‚   â”‚   â€¢ çŠ¶æ€ç®¡ç†ï¼ˆStateGraphï¼‰                               â”‚   â”‚
â”‚   â”‚   â€¢ å¤æ‚æµç¨‹ï¼šåˆ†æ”¯ã€å¾ªç¯ã€å¹¶è¡Œ                            â”‚   â”‚
â”‚   â”‚   â€¢ Agent æ¨¡å¼ï¼ˆReActï¼‰                                  â”‚   â”‚
â”‚   â”‚   â€¢ æ£€æŸ¥ç‚¹/è®°å¿†ï¼ˆCheckpointerï¼‰                          â”‚   â”‚
â”‚   â”‚   â€¢ ä¸»è¦å¤„ç†ï¼šéçº¿æ€§ã€æœ‰çŠ¶æ€çš„å¤æ‚æµç¨‹                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†å¯¹æ¯”

| å±‚é¢         | LangChain                    | LangGraph                      |
| ------------ | ---------------------------- | ------------------------------ |
| **å®šä½**     | åŸºç¡€ç»„ä»¶åº“                   | å·¥ä½œæµç¼–æ’æ¡†æ¶                 |
| **æä¾›**     | LLMã€Promptã€Toolsã€Memory   | çŠ¶æ€ç®¡ç†ã€å¾ªç¯ã€æ¡ä»¶åˆ†æ”¯       |
| **æµç¨‹**     | çº¿æ€§æµç¨‹                     | å¤æ‚çš„éçº¿æ€§æµç¨‹               |
| **Agent**    | æ—©æœŸæœ‰ç®€å• Agent API         | **æ¨èçš„ Agent æ„å»ºæ–¹å¼**      |
| **é€‚ç”¨åœºæ™¯** | ç®€å•çš„ Prompt â†’ LLM â†’ Parser | æ¡ä»¶åˆ†æ”¯ã€å¾ªç¯è¿­ä»£ã€å¤æ‚ Agent |

### é…åˆä½¿ç”¨ç¤ºä¾‹

```javascript
// LangChain ç»„ä»¶
import { ChatDeepSeek } from "@langchain/deepseek";
import { ChatPromptTemplate } from "@langchain/core/prompts";
import { DynamicStructuredTool } from "@langchain/core/tools";

// LangGraph ç¼–æ’
import { StateGraph, Annotation } from "@langchain/langgraph";

// ç»„åˆä½¿ç”¨
const llm = new ChatDeepSeek({ model: "deepseek-chat" });
const tools = [
  new DynamicStructuredTool({
    /* ... */
  }),
];
const llmWithTools = llm.bindTools(tools); // LangChain èƒ½åŠ›

const graph = new StateGraph(State) // LangGraph ç¼–æ’
  .addNode("agent", async (state) => {
    const response = await llmWithTools.invoke(state.messages);
    return { messages: [response] };
  });
```

### é€‰æ‹©æŒ‡å—

| åœºæ™¯                         | é€‰æ‹©             |
| ---------------------------- | ---------------- |
| ç®€å•çš„ Prompt â†’ LLM â†’ Parser | LangChain pipe() |
| RAG æ£€ç´¢é—®ç­”                 | LangChain        |
| å¤šæ­¥éª¤ç”Ÿæˆæµç¨‹               | ä¸¤è€…éƒ½å¯         |
| æ¡ä»¶åˆ†æ”¯é€»è¾‘                 | LangGraph        |
| å¾ªç¯/è¿­ä»£ä»»åŠ¡                | LangGraph        |
| **å¤æ‚ Agent**               | **LangGraph**    |
| å¤š Agent åä½œ                | LangGraph        |

### ä¸ºä»€ä¹ˆ Agent è¦ç”¨ LangGraphï¼Ÿ

Agent çš„ ReAct æ¨¡å¼éœ€è¦ï¼š

- âœ… **å¾ªç¯è¿­ä»£** - LangGraph åŸç”Ÿæ”¯æŒ
- âœ… **æ¡ä»¶åˆ†æ”¯** - æ ¹æ®å·¥å…·è°ƒç”¨ç»“æœå†³å®šä¸‹ä¸€æ­¥
- âœ… **çŠ¶æ€ç®¡ç†** - è‡ªåŠ¨ç®¡ç†å¯¹è¯å†å²å’Œä¸­é—´çŠ¶æ€

è¿™äº›èƒ½åŠ› LangChain çš„ç®€å• `pipe()` éš¾ä»¥å®ç°ï¼Œä½† LangGraph åŸç”Ÿæ”¯æŒã€‚

> ğŸ’¡ **æ€»ç»“**ï¼šAgent çš„**æ¦‚å¿µå’Œç»„ä»¶**ï¼ˆå¦‚ Toolsï¼‰æ¥è‡ª LangChainï¼Œä½†**æ„å»ºå’Œç¼–æ’ Agent çš„èƒ½åŠ›**ä¸»è¦ç”± LangGraph æä¾›ã€‚ç°åœ¨å®˜æ–¹æ¨èä½¿ç”¨ LangGraph æ¥æ„å»ºç”Ÿäº§çº§çš„ Agentã€‚

---

## ä»€ä¹ˆæ˜¯ Agent

### ğŸ¤” ä¸€å¥è¯è§£é‡Š

**Agentï¼ˆæ™ºèƒ½ä»£ç†ï¼‰æ˜¯èƒ½å¤Ÿè‡ªä¸»æ€è€ƒã€å†³ç­–å¹¶æ‰§è¡Œä»»åŠ¡çš„ AI ç³»ç»Ÿã€‚**

å®ƒä¸ä»…èƒ½"è¯´"ï¼ˆç”Ÿæˆæ–‡æœ¬ï¼‰ï¼Œè¿˜èƒ½"åš"ï¼ˆè°ƒç”¨å·¥å…·æ‰§è¡Œæ“ä½œï¼‰ã€‚

### å½¢è±¡æ¯”å–»

æƒ³è±¡ä½ é›‡äº†ä¸€ä¸ªåŠ©ç†ï¼š

| ç±»å‹         | è¡Œä¸ºç‰¹ç‚¹                                    |
| ------------ | ------------------------------------------- |
| **æ™®é€š AI**  | åªä¼šå›ç­”é—®é¢˜ï¼Œ"å¤©æ°”æˆ‘ä¸çŸ¥é“ï¼Œä½ è‡ªå·±æŸ¥å§"    |
| **AI Agent** | ä¼šä¸»åŠ¨è¡ŒåŠ¨ï¼Œ"æˆ‘å¸®ä½ æŸ¥ä¸€ä¸‹... åŒ—äº¬ä»Šå¤© 15Â°C" |

**Agent = æœ‰æ‰‹æœ‰è„šçš„ AI**

### Agent çš„æ ¸å¿ƒèƒ½åŠ›

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Agent çš„æ ¸å¿ƒèƒ½åŠ›                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ§  æ¨ç†èƒ½åŠ› (Reasoning)                                    â”‚
â”‚     ç†è§£ç”¨æˆ·æ„å›¾ï¼Œåˆ†è§£ä»»åŠ¡ï¼Œåˆ¶å®šè®¡åˆ’                          â”‚
â”‚                                                             â”‚
â”‚  ğŸ”§ å·¥å…·ä½¿ç”¨ (Tool Use)                                     â”‚
â”‚     è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼šæœç´¢ã€è®¡ç®—ã€APIã€æ•°æ®åº“ç­‰                   â”‚
â”‚                                                             â”‚
â”‚  ğŸ”„ è‡ªä¸»å¾ªç¯ (Autonomous Loop)                              â”‚
â”‚     æ€è€ƒ â†’ è¡ŒåŠ¨ â†’ è§‚å¯Ÿ â†’ å†æ€è€ƒï¼Œç›´åˆ°å®Œæˆä»»åŠ¡                 â”‚
â”‚                                                             â”‚
â”‚  ğŸ“ è®°å¿†èƒ½åŠ› (Memory)                                       â”‚
â”‚     è®°ä½å¯¹è¯å†å²å’Œä¸Šä¸‹æ–‡ï¼Œä¿æŒè¿è´¯æ€§                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Agent vs æ™®é€š LLM

### å…³é”®åŒºåˆ«

| å¯¹æ¯”ç»´åº¦     | æ™®é€š LLM           | Agent                       |
| ------------ | ------------------ | --------------------------- |
| **èƒ½åŠ›è¾¹ç•Œ** | åªèƒ½ç”Ÿæˆæ–‡æœ¬       | å¯ä»¥è°ƒç”¨å·¥å…·ã€æ‰§è¡Œæ“ä½œ      |
| **ä¿¡æ¯æ¥æº** | ä»…é™è®­ç»ƒæ•°æ®       | å¯è·å–å®æ—¶ä¿¡æ¯ï¼ˆæœç´¢ã€APIï¼‰ |
| **ä»»åŠ¡æ‰§è¡Œ** | ä¸€é—®ä¸€ç­”ï¼Œè¢«åŠ¨å“åº” | è‡ªä¸»è§„åˆ’ã€å¤šæ­¥æ‰§è¡Œ          |
| **å†³ç­–æ–¹å¼** | æ—                  | æ ¹æ®æƒ…å†µè‡ªä¸»å†³å®šä¸‹ä¸€æ­¥      |
| **å¤æ‚ä»»åŠ¡** | éš¾ä»¥å¤„ç†           | å¯åˆ†è§£å¹¶é€æ­¥å®Œæˆ            |

### å®é™…å¯¹æ¯”ç¤ºä¾‹

**åœºæ™¯ï¼šç”¨æˆ·é—®ã€Œå¸®æˆ‘è®¢ä¸€å¼ æ˜å¤©å»ä¸Šæµ·çš„æœºç¥¨ã€**

#### æ™®é€š LLM çš„å›ç­”

```
æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å¸®æ‚¨è®¢æœºç¥¨ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼é¢„è®¢ï¼š
1. è®¿é—®æºç¨‹ã€å»å“ªå„¿ç­‰ç½‘ç«™
2. ä¸‹è½½èˆªç©ºå…¬å¸ App
3. æ‹¨æ‰“èˆªç©ºå…¬å¸å®¢æœç”µè¯
...
```

#### Agent çš„è¡Œä¸º

```
[æ€è€ƒ] ç”¨æˆ·æƒ³è®¢æœºç¥¨ï¼Œæˆ‘éœ€è¦ï¼š
  1. ç¡®è®¤å‡ºå‘åœ°
  2. æœç´¢èˆªç­
  3. é€‰æ‹©åˆé€‚çš„èˆªç­
  4. å®Œæˆé¢„è®¢

[è¡ŒåŠ¨ 1] è°ƒç”¨ search_flights(from="åŒ—äº¬", to="ä¸Šæµ·", date="æ˜å¤©")
[è§‚å¯Ÿ 1] æ‰¾åˆ° 15 ä¸ªèˆªç­ï¼Œæœ€ä½ä»· Â¥550

[è¡ŒåŠ¨ 2] è°ƒç”¨ get_flight_details(flight_id="CA1234")
[è§‚å¯Ÿ 2] CA1234ï¼Œ08:00-10:30ï¼ŒÂ¥680

[æ€è€ƒ] éœ€è¦ç”¨æˆ·ç¡®è®¤èˆªç­é€‰æ‹©...

[å›ç­”] æˆ‘æ‰¾åˆ°äº† 15 ä¸ªèˆªç­ï¼Œæ¨èä»¥ä¸‹é€‰é¡¹ï¼š
  - CA1234ï¼Œ08:00-10:30ï¼ŒÂ¥680
  - MU5678ï¼Œ10:00-12:30ï¼ŒÂ¥550
  è¯·é—®æ‚¨æƒ³é¢„è®¢å“ªä¸ªï¼Ÿ
```

---

# Part 2: ReAct æ¨¡å¼

## ReAct æ¨¡å¼è¯¦è§£

### ä»€ä¹ˆæ˜¯ ReActï¼Ÿ

**ReAct = Reasoning + Actingï¼ˆæ¨ç† + è¡ŒåŠ¨ï¼‰**

è¿™æ˜¯æ„å»º Agent æœ€æµè¡Œçš„èŒƒå¼ï¼Œæºè‡ª 2022 å¹´çš„è®ºæ–‡ã€ŠReAct: Synergizing Reasoning and Acting in Language Modelsã€‹ã€‚

### ReAct çš„æ ¸å¿ƒå¾ªç¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ReAct å¾ªç¯æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚    â”‚ Thought â”‚ æ€è€ƒï¼šåˆ†æå½“å‰çŠ¶æ€ï¼Œå†³å®šä¸‹ä¸€æ­¥               â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                             â”‚
â”‚         â”‚                                                  â”‚
â”‚         â–¼                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚    â”‚ Action  â”‚ è¡ŒåŠ¨ï¼šè°ƒç”¨å·¥å…·æ‰§è¡Œæ“ä½œ                       â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                             â”‚
â”‚         â”‚                                                  â”‚
â”‚         â–¼                                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚    â”‚ Observation â”‚ è§‚å¯Ÿï¼šè·å–å·¥å…·è¿”å›çš„ç»“æœ                  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚           â”‚                                                â”‚
â”‚           â–¼                                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚    â”‚   å†æ¬¡æ€è€ƒ    â”‚ æ˜¯å¦éœ€è¦ç»§ç»­ï¼Ÿ                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚           â”‚                                                â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                          â”‚
â”‚     â”‚           â”‚                                          â”‚
â”‚     â–¼           â–¼                                          â”‚
â”‚   ç»§ç»­å¾ªç¯    ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ                                   â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…·ä½“ç¤ºä¾‹

**ç”¨æˆ·é—®ï¼šåŒ—äº¬æ¯”ä¸Šæµ·å†·å¤šå°‘åº¦ï¼Ÿ**

```
[Thought 1]
ç”¨æˆ·æƒ³çŸ¥é“æ¸©åº¦å·®ï¼Œæˆ‘éœ€è¦ï¼š
1. æŸ¥è¯¢åŒ—äº¬å¤©æ°”
2. æŸ¥è¯¢ä¸Šæµ·å¤©æ°”
3. è®¡ç®—æ¸©åº¦å·®

[Action 1]
è°ƒç”¨ get_weather(city="åŒ—äº¬")

[Observation 1]
{"city": "åŒ—äº¬", "temperature": "5Â°C", "condition": "æ™´å¤©"}

[Thought 2]
å·²è·å–åŒ—äº¬æ¸©åº¦ 5Â°Cï¼Œç°åœ¨éœ€è¦æŸ¥ä¸Šæµ·

[Action 2]
è°ƒç”¨ get_weather(city="ä¸Šæµ·")

[Observation 2]
{"city": "ä¸Šæµ·", "temperature": "12Â°C", "condition": "å¤šäº‘"}

[Thought 3]
åŒ—äº¬ 5Â°Cï¼Œä¸Šæµ· 12Â°Cï¼Œéœ€è¦è®¡ç®—å·®å€¼

[Action 3]
è°ƒç”¨ calculator(expression="12 - 5")

[Observation 3]
12 - 5 = 7

[Thought 4]
è®¡ç®—å®Œæˆï¼Œä¸Šæµ·æ¯”åŒ—äº¬é«˜ 7 åº¦ï¼Œå¯ä»¥å›ç­”äº†

[Final Answer]
ç›®å‰åŒ—äº¬æ°”æ¸© 5Â°Cï¼Œä¸Šæµ·æ°”æ¸© 12Â°Cï¼Œä¸Šæµ·æ¯”åŒ—äº¬é«˜ 7Â°Cã€‚
åŒ—äº¬ä»Šå¤©ä¼šæ¯”è¾ƒå†·ï¼Œå‡ºé—¨è®°å¾—å¤šç©¿è¡£æœï¼
```

### ä¸ºä»€ä¹ˆ ReAct æœ‰æ•ˆï¼Ÿ

| ä¼˜åŠ¿         | è¯´æ˜                                |
| ------------ | ----------------------------------- |
| **å¯è§£é‡Šæ€§** | æ¯ä¸€æ­¥æ€è€ƒéƒ½å¯è§ï¼Œä¾¿äºè°ƒè¯•å’Œç†è§£    |
| **å‡†ç¡®æ€§**   | é€šè¿‡å·¥å…·è·å–çœŸå®æ•°æ®ï¼Œé¿å… LLM å¹»è§‰ |
| **çµæ´»æ€§**   | å¯æ ¹æ®ä¸­é—´ç»“æœåŠ¨æ€è°ƒæ•´ç­–ç•¥          |
| **å¯æ‰©å±•æ€§** | åªéœ€æ·»åŠ æ–°å·¥å…·å³å¯æ‰©å±• Agent èƒ½åŠ›   |

---

# Part 3: Agent æ ¸å¿ƒç»„ä»¶

## ç»„ä»¶æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Agent æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      ğŸ§  LLMï¼ˆå¤§è„‘ï¼‰                    â”‚  â”‚
â”‚  â”‚  â€¢ ç†è§£ç”¨æˆ·æ„å›¾                                        â”‚  â”‚
â”‚  â”‚  â€¢ æ¨ç†å’Œå†³ç­–                                          â”‚  â”‚
â”‚  â”‚  â€¢ ç”Ÿæˆå›ç­”                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                               â”‚
â”‚                             â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ğŸ”§ Toolsï¼ˆå·¥å…·ï¼‰                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚  â”‚  å¤©æ°”   â”‚ â”‚  æœç´¢   â”‚ â”‚  è®¡ç®—   â”‚ â”‚ æ•°æ®åº“  â”‚ ...  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                               â”‚
â”‚                             â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ğŸ“‹ Stateï¼ˆçŠ¶æ€ï¼‰                    â”‚  â”‚
â”‚  â”‚  â€¢ messages: å¯¹è¯å†å²                                  â”‚  â”‚
â”‚  â”‚  â€¢ å…¶ä»–ä¸Šä¸‹æ–‡ä¿¡æ¯                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                               â”‚
â”‚                             â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   ğŸ”„ Graphï¼ˆæµç¨‹å›¾ï¼‰                   â”‚  â”‚
â”‚  â”‚  å®šä¹‰èŠ‚ç‚¹ä¹‹é—´çš„æµè½¬é€»è¾‘                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 1. LLMï¼ˆå¤§è„‘ï¼‰

LLM æ˜¯ Agent çš„æ ¸å¿ƒï¼Œè´Ÿè´£ï¼š

- **ç†è§£**ï¼šè§£æç”¨æˆ·æ„å›¾
- **æ¨ç†**ï¼šåˆ†æé—®é¢˜ï¼Œåˆ¶å®šç­–ç•¥
- **å†³ç­–**ï¼šé€‰æ‹©åˆé€‚çš„å·¥å…·
- **ç”Ÿæˆ**ï¼šäº§å‡ºæœ€ç»ˆå›ç­”

```javascript
import { ChatDeepSeek } from "@langchain/deepseek";

const llm = new ChatDeepSeek({
  model: "deepseek-chat",
  temperature: 0, // å·¥å…·è°ƒç”¨å»ºè®®ä½æ¸©åº¦
});
```

## 2. Toolsï¼ˆå·¥å…·ï¼‰

å·¥å…·æ˜¯ Agent çš„"åŒæ‰‹"ï¼Œæ‰©å±• Agent çš„èƒ½åŠ›è¾¹ç•Œï¼š

```javascript
import { DynamicStructuredTool } from "@langchain/core/tools";
import { z } from "zod";

// ç¤ºä¾‹ï¼šå¤©æ°”æŸ¥è¯¢å·¥å…·
const weatherTool = new DynamicStructuredTool({
  name: "get_weather",
  description: "è·å–åŸå¸‚å¤©æ°”ä¿¡æ¯ã€‚å½“ç”¨æˆ·è¯¢é—®å¤©æ°”æ—¶ä½¿ç”¨ã€‚",
  schema: z.object({
    city: z.string().describe("åŸå¸‚åç§°"),
  }),
  func: async ({ city }) => {
    // è°ƒç”¨å¤©æ°” API
    return JSON.stringify({ city, temp: "15Â°C", condition: "æ™´å¤©" });
  },
});
```

## 3. Stateï¼ˆçŠ¶æ€ï¼‰

çŠ¶æ€ä¿å­˜ Agent çš„"è®°å¿†"ï¼š

```javascript
import { Annotation } from "@langchain/langgraph";

const AgentState = Annotation.Root({
  messages: Annotation({
    reducer: (prev, next) => [...prev, ...next], // ç´¯åŠ æ¶ˆæ¯
    default: () => [],
  }),
});
```

**æ¶ˆæ¯ç±»å‹ï¼š**

| ç±»å‹            | è¯´æ˜                             |
| --------------- | -------------------------------- |
| `HumanMessage`  | ç”¨æˆ·å‘é€çš„æ¶ˆæ¯                   |
| `AIMessage`     | AI çš„å›å¤ï¼ˆå¯èƒ½åŒ…å« tool_callsï¼‰ |
| `ToolMessage`   | å·¥å…·æ‰§è¡Œçš„ç»“æœ                   |
| `SystemMessage` | ç³»ç»ŸæŒ‡ä»¤                         |

## 4. Graphï¼ˆæµç¨‹å›¾ï¼‰

ä½¿ç”¨ LangGraph å®šä¹‰ Agent çš„æ‰§è¡Œæµç¨‹ï¼š

```javascript
import { StateGraph, START, END } from "@langchain/langgraph";

const graph = new StateGraph(AgentState)
  .addNode("agent", agentNode) // æ€è€ƒèŠ‚ç‚¹
  .addNode("tools", toolNode) // å·¥å…·èŠ‚ç‚¹
  .addEdge(START, "agent")
  .addConditionalEdges("agent", shouldCallTools, {
    tools: "tools",
    end: END,
  })
  .addEdge("tools", "agent"); // å…³é”®ï¼šå¾ªç¯ï¼
```

---

# Part 4: æ„å»º Agent

## ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
npm install @langchain/langgraph @langchain/core @langchain/deepseek zod dotenv
```

```javascript
// .env æ–‡ä»¶
DEEPSEEK_API_KEY = your_api_key;
```

## å®Œæ•´ä»£ç ç¤ºä¾‹

```javascript
/**
 * ä½¿ç”¨ LangGraph æ„å»º ReAct Agent
 */
import { StateGraph, Annotation, START, END } from "@langchain/langgraph";
import { ToolNode } from "@langchain/langgraph/prebuilt";
import { ChatDeepSeek } from "@langchain/deepseek";
import { DynamicStructuredTool } from "@langchain/core/tools";
import { HumanMessage } from "@langchain/core/messages";
import { z } from "zod";
import "dotenv/config";

// 1. å®šä¹‰å·¥å…·
const tools = [
  new DynamicStructuredTool({
    name: "get_weather",
    description: "è·å–åŸå¸‚å¤©æ°”",
    schema: z.object({ city: z.string() }),
    func: async ({ city }) => {
      const data = { åŒ—äº¬: "15Â°C æ™´", ä¸Šæµ·: "20Â°C å¤šäº‘" };
      return data[city] || "22Â°C æ™´å¤©";
    },
  }),
  new DynamicStructuredTool({
    name: "calculator",
    description: "æ•°å­¦è®¡ç®—",
    schema: z.object({ expression: z.string() }),
    func: async ({ expression }) => {
      return String(Function(`"use strict"; return (${expression})`)());
    },
  }),
];

// 2. åˆå§‹åŒ– LLM å¹¶ç»‘å®šå·¥å…·
const llm = new ChatDeepSeek({ model: "deepseek-chat", temperature: 0 });
const llmWithTools = llm.bindTools(tools);

// 3. å®šä¹‰çŠ¶æ€
const AgentState = Annotation.Root({
  messages: Annotation({
    reducer: (prev, next) => [...prev, ...next],
    default: () => [],
  }),
});

// 4. å®šä¹‰èŠ‚ç‚¹
async function agentNode(state) {
  const response = await llmWithTools.invoke(state.messages);
  return { messages: [response] };
}

const toolNode = new ToolNode(tools);

// 5. å®šä¹‰è·¯ç”±
function shouldCallTools(state) {
  const last = state.messages[state.messages.length - 1];
  return last.tool_calls?.length > 0 ? "tools" : "end";
}

// 6. æ„å»ºå›¾
const graph = new StateGraph(AgentState)
  .addNode("agent", agentNode)
  .addNode("tools", toolNode)
  .addEdge(START, "agent")
  .addConditionalEdges("agent", shouldCallTools, {
    tools: "tools",
    end: END,
  })
  .addEdge("tools", "agent");

// 7. ç¼–è¯‘å¹¶ä½¿ç”¨
const agent = graph.compile();

const result = await agent.invoke({
  messages: [new HumanMessage("åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")],
});

console.log(result.messages[result.messages.length - 1].content);
```

### ä»£ç è§£æ

#### æ­¥éª¤ 1-2ï¼šå®šä¹‰å·¥å…·å¹¶ç»‘å®š

```javascript
// åˆ›å»ºå·¥å…·
const tools = [weatherTool, calculatorTool];

// ç»‘å®šåˆ° LLMï¼ˆå…³é”®ï¼ï¼‰
const llmWithTools = llm.bindTools(tools);
```

`bindTools()` å‘Šè¯‰ LLM æœ‰å“ªäº›å·¥å…·å¯ç”¨ï¼ŒLLM ä¼šï¼š

- åœ¨éœ€è¦æ—¶è¿”å› `tool_calls`
- åŒ…å«å·¥å…·åç§°å’Œå‚æ•°

#### æ­¥éª¤ 3ï¼šå®šä¹‰çŠ¶æ€

```javascript
const AgentState = Annotation.Root({
  messages: Annotation({
    reducer: (prev, next) => [...prev, ...next], // ç´¯åŠ ï¼
    default: () => [],
  }),
});
```

**ä¸ºä»€ä¹ˆç”¨ç´¯åŠ æ¨¡å¼ï¼Ÿ**

- å¯¹è¯éœ€è¦ä¿ç•™å†å²
- LLM éœ€è¦å®Œæ•´ä¸Šä¸‹æ–‡
- å·¥å…·ç»“æœéœ€è¦è¿½åŠ 

#### æ­¥éª¤ 4ï¼šå®šä¹‰èŠ‚ç‚¹

```javascript
// Agent èŠ‚ç‚¹ï¼šè°ƒç”¨ LLM åšå†³ç­–
async function agentNode(state) {
  const response = await llmWithTools.invoke(state.messages);
  return { messages: [response] };
}

// Tool èŠ‚ç‚¹ï¼šæ‰§è¡Œå·¥å…·ï¼ˆä½¿ç”¨å†…ç½® ToolNodeï¼‰
const toolNode = new ToolNode(tools);
```

`ToolNode` è‡ªåŠ¨å¤„ç†ï¼š

1. è§£æ `tool_calls`
2. æ‰§è¡Œå¯¹åº”å·¥å…·
3. åŒ…è£…ç»“æœä¸º `ToolMessage`

#### æ­¥éª¤ 5ï¼šå®šä¹‰è·¯ç”±

```javascript
function shouldCallTools(state) {
  const last = state.messages[state.messages.length - 1];
  // æœ‰ tool_calls â†’ å»æ‰§è¡Œå·¥å…·
  // æ²¡æœ‰ â†’ ç»“æŸ
  return last.tool_calls?.length > 0 ? "tools" : "end";
}
```

#### æ­¥éª¤ 6ï¼šæ„å»ºå›¾

```javascript
const graph = new StateGraph(AgentState)
  .addNode("agent", agentNode)
  .addNode("tools", toolNode)
  .addEdge(START, "agent") // å…¥å£
  .addConditionalEdges("agent", shouldCallTools, {
    tools: "tools",
    end: END,
  })
  .addEdge("tools", "agent"); // å¾ªç¯å› agentï¼
```

**å…³é”®ï¼š`tools â†’ agent` å½¢æˆå¾ªç¯ï¼**

è¿™è®© Agent å¯ä»¥å¤šæ¬¡è°ƒç”¨å·¥å…·ï¼Œç›´åˆ°å®Œæˆä»»åŠ¡ã€‚

---

## Agent çš„å·¥ä½œæµç¨‹

### æµç¨‹å›¾

```
                    ç”¨æˆ·è¾“å…¥
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   START        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Agent èŠ‚ç‚¹   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   (LLM æ€è€ƒ)   â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                      â”‚                        â”‚
                      â–¼                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
              â”‚   è·¯ç”±åˆ¤æ–­      â”‚               â”‚
              â”‚ æœ‰ tool_calls? â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                      â”‚                        â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
           â”‚ Yes                 â”‚ No          â”‚
           â–¼                     â–¼             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚ Tools èŠ‚ç‚¹ â”‚        â”‚    END     â”‚       â”‚
    â”‚ (æ‰§è¡Œå·¥å…·) â”‚         â”‚  è¾“å‡ºç»“æœ   â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
          â”‚                                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   å·¥å…·ç»“æœè¿”å›
```

### æ¶ˆæ¯æµè½¬ç¤ºä¾‹

ä»¥ã€ŒåŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿã€ä¸ºä¾‹ï¼š

```javascript
// åˆå§‹çŠ¶æ€
messages: [
  HumanMessage("åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")
]

// Agent èŠ‚ç‚¹æ‰§è¡Œå
messages: [
  HumanMessage("åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"),
  AIMessage({
    content: "",
    tool_calls: [{ name: "get_weather", args: { city: "åŒ—äº¬" } }]
  })
]

// Tools èŠ‚ç‚¹æ‰§è¡Œå
messages: [
  HumanMessage("åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"),
  AIMessage({ tool_calls: [...] }),
  ToolMessage({ content: '{"city":"åŒ—äº¬","temp":"15Â°C"}' })
]

// Agent èŠ‚ç‚¹å†æ¬¡æ‰§è¡Œåï¼ˆæœ€ç»ˆï¼‰
messages: [
  HumanMessage("åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"),
  AIMessage({ tool_calls: [...] }),
  ToolMessage({ content: '...' }),
  AIMessage({ content: "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©15Â°Cï¼Œé€‚åˆå‡ºè¡Œï¼" })
]
```

---

# Part 5: è®°å¿†åŠŸèƒ½

## ä¸ºä»€ä¹ˆéœ€è¦è®°å¿†

### æ²¡æœ‰è®°å¿†çš„é—®é¢˜

```javascript
// âŒ æ²¡æœ‰è®°å¿†çš„å¯¹è¯ï¼ˆæ¯æ¬¡éƒ½æ˜¯å…¨æ–°çš„ï¼‰

// ç¬¬ä¸€æ¬¡å¯¹è¯
await app.invoke({ messages: [new HumanMessage("æˆ‘å«å°æ˜")] });
// AI: "ä½ å¥½å°æ˜ï¼"

// ç¬¬äºŒæ¬¡å¯¹è¯ï¼ˆAI å®Œå…¨ä¸è®°å¾—ï¼ï¼‰
await app.invoke({ messages: [new HumanMessage("æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ")] });
// AI: "æŠ±æ­‰ï¼Œæˆ‘ä¸çŸ¥é“ä½ çš„åå­—ï¼Œä½ è¿˜æ²¡å‘Šè¯‰æˆ‘å‘¢"  â† å°´å°¬ï¼
```

### æœ‰è®°å¿†åçš„æ•ˆæœ

```javascript
// âœ… æœ‰è®°å¿†çš„å¯¹è¯ï¼ˆè¿è´¯è‡ªç„¶ï¼‰

// ç¬¬ä¸€æ¬¡å¯¹è¯
await app.invoke(
  { messages: [new HumanMessage("æˆ‘å«å°æ˜")] },
  { configurable: { thread_id: "user_001" } }
);
// AI: "ä½ å¥½å°æ˜ï¼"

// ç¬¬äºŒæ¬¡å¯¹è¯ï¼ˆåŒä¸€ä¸ª thread_idï¼ŒAI è®°å¾—ï¼ï¼‰
await app.invoke(
  { messages: [new HumanMessage("æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ")] },
  { configurable: { thread_id: "user_001" } }
);
// AI: "ä½ å«å°æ˜å‘€ï¼"  â† å®Œç¾ï¼
```

### è®°å¿†åŠŸèƒ½çš„åº”ç”¨åœºæ™¯

| åœºæ™¯           | æè¿°               | ä¸ºä»€ä¹ˆéœ€è¦è®°å¿†                     |
| -------------- | ------------------ | ---------------------------------- |
| **å®¢æœæœºå™¨äºº** | å¤„ç†ç”¨æˆ·é—®é¢˜       | è®°ä½ç”¨æˆ·èº«ä»½ã€ä¹‹å‰çš„é—®é¢˜ã€å¤„ç†è¿›åº¦ |
| **ä¸ªäººåŠ©ç†**   | æ—¥ç¨‹ç®¡ç†ã€ä»»åŠ¡è·Ÿè¸ª | è®°ä½ç”¨æˆ·åå¥½ã€å¾…åŠäº‹é¡¹ã€ä¸Šä¸‹æ–‡     |
| **æ•™è‚²è¾…å¯¼**   | ä¸€å¯¹ä¸€æ•™å­¦         | è®°ä½å­¦ä¹ è¿›åº¦ã€è–„å¼±ç‚¹ã€å­¦ä¹ é£æ ¼     |
| **æ¸¸æˆ NPC**   | äº¤äº’å¼å¯¹è¯         | è®°ä½å‰§æƒ…è¿›å±•ã€ç©å®¶é€‰æ‹©ã€å…³ç³»çŠ¶æ€   |
| **å¿ƒç†å’¨è¯¢**   | é™ªä¼´å¯¹è¯           | è®°ä½ç”¨æˆ·æƒ…å†µã€å†å²å¯¹è¯ã€æƒ…ç»ªå˜åŒ–   |

---

## MemorySaver è¯¦è§£

### ä»€ä¹ˆæ˜¯ MemorySaver

**MemorySaver = è®© AI è®°ä½å¯¹è¯å†å²çš„å·¥å…·**

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ å’Œæœ‹å‹èŠå¤©ï¼š

- âŒ æ²¡æœ‰ MemorySaverï¼šæ¯å¥è¯ AI éƒ½å½“ä½œæ–°å¯¹è¯ï¼Œå®Œå…¨ä¸è®°å¾—ä¹‹å‰è¯´äº†ä»€ä¹ˆ
- âœ… æœ‰ MemorySaverï¼šAI èƒ½è®°ä½ä½ è¯´è¿‡çš„æ¯ä¸€å¥è¯ï¼ŒåƒçœŸäººä¸€æ ·è¿è´¯å¯¹è¯

### å½¢è±¡æ¯”å–»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚   ğŸ“ MemorySaver å°±åƒä¸€æœ¬ã€Œå¯¹è¯æ—¥è®°ã€                             â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  å¯¹è¯æ—¥è®° (thread_id: "user_001")                      â”‚    â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚    â”‚
â”‚   â”‚  [è½®æ¬¡ 1] ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘å«å°æ˜                          â”‚    â”‚
â”‚   â”‚          AI:   ä½ å¥½å°æ˜ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ              â”‚    â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚    â”‚
â”‚   â”‚  [è½®æ¬¡ 2] ç”¨æˆ·: æˆ‘å–œæ¬¢ç¼–ç¨‹                              â”‚    â”‚
â”‚   â”‚          AI:   ç¼–ç¨‹å¾ˆæ£’ï¼å°æ˜ï¼Œä½ ä¸»è¦ç”¨ä»€ä¹ˆè¯­è¨€å‘¢ï¼Ÿ       â”‚    â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚    â”‚
â”‚   â”‚  [è½®æ¬¡ 3] ç”¨æˆ·: æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ                          â”‚    â”‚
â”‚   â”‚          AI:   ä½ å«å°æ˜å‘€ï¼ï¼ˆå› ä¸ºæˆ‘è®°å¾—ï¼ï¼‰              â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚   ğŸ“Œ å…³é”®ç‚¹ï¼šAI èƒ½å›å¿†èµ·ä¹‹å‰è¯´çš„"å°æ˜"å’Œ"å–œæ¬¢ç¼–ç¨‹"              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¦‚å¿µ

#### ğŸ”¹ Checkpointerï¼ˆæ£€æŸ¥ç‚¹å™¨ï¼‰

**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ¸¸æˆé‡Œçš„ã€Œå­˜æ¡£åŠŸèƒ½ã€

- æ¸¸æˆå­˜æ¡£ï¼šä¿å­˜æ¸¸æˆè¿›åº¦ï¼Œä¸‹æ¬¡å¯ä»¥ç»§ç»­ç©
- Checkpointerï¼šä¿å­˜å¯¹è¯çŠ¶æ€ï¼Œä¸‹æ¬¡å¯ä»¥ç»§ç»­èŠ

```
æ¸¸æˆå­˜æ¡£                          LangGraph Checkpointer
â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å­˜æ¡£ä½ç½®: ç¬¬3å…³Bosså‰              å­˜æ¡£ä½ç½®: ç¬¬5è½®å¯¹è¯å
è§’è‰²ç­‰çº§: 50çº§                     æ¶ˆæ¯å†å²: [msg1, msg2, ...]
èƒŒåŒ…ç‰©å“: [å‰‘, ç›¾, è¯æ°´]           çŠ¶æ€æ•°æ®: { topic: "ç¼–ç¨‹", ... }
```

#### ğŸ”¹ MemorySaver

**é€šä¿—è§£é‡Š**ï¼šå°†å­˜æ¡£ä¿å­˜åœ¨ã€Œå†…å­˜ã€é‡Œçš„å­˜æ¡£å™¨

- ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ã€ä½¿ç”¨ç®€å•
- ç¼ºç‚¹ï¼šç¨‹åºå…³é—­åå­˜æ¡£ä¸¢å¤±ï¼ˆå°±åƒæ²¡æœ‰æ’è®°å¿†å¡çš„æ¸¸æˆæœºï¼‰

```javascript
import { MemorySaver } from "@langchain/langgraph";

const memory = new MemorySaver(); // åˆ›å»ºä¸€ä¸ª"å†…å­˜å­˜æ¡£å™¨"
```

### åŸºæœ¬ä½¿ç”¨æ­¥éª¤

```javascript
import { StateGraph, Annotation, START, END } from "@langchain/langgraph";
import { MemorySaver } from "@langchain/langgraph"; // 1ï¸âƒ£ å¯¼å…¥

// 2ï¸âƒ£ åˆ›å»º MemorySaver å®ä¾‹
const memory = new MemorySaver();

// 3ï¸âƒ£ å®šä¹‰çŠ¶æ€
const ChatState = Annotation.Root({
  messages: Annotation({
    reducer: (prev, next) => [...prev, ...next],
    default: () => [],
  }),
});

// 4ï¸âƒ£ æ„å»ºå›¾
const graph = new StateGraph(ChatState)
  .addNode("chat", chatNode)
  .addEdge(START, "chat")
  .addEdge("chat", END);

// 5ï¸âƒ£ ç¼–è¯‘æ—¶ä¼ å…¥ checkpointer
const app = graph.compile({
  checkpointer: memory, // å…³é”®ï¼æ·»åŠ è®°å¿†åŠŸèƒ½
});

// 6ï¸âƒ£ è°ƒç”¨æ—¶æŒ‡å®š thread_id
const result = await app.invoke(
  { messages: [new HumanMessage("ä½ å¥½")] },
  { configurable: { thread_id: "my_thread_123" } } // å…³é”®ï¼æŒ‡å®šå¯¹è¯çº¿ç¨‹
);
```

> ğŸ’¡ **å…³é”®ç†è§£**ï¼š`compile()` ä¸ä¼  `checkpointer` æ—¶ï¼Œåº”ç”¨æ²¡æœ‰è®°å¿†åŠŸèƒ½ï¼›ä¼ äº†æ‰æœ‰ï¼

---

## thread_id çº¿ç¨‹æ ‡è¯†

### ä»€ä¹ˆæ˜¯ thread_id

**thread_id æ˜¯å¯¹è¯çš„ã€Œèº«ä»½è¯å·ã€**ï¼Œç”¨æ¥åŒºåˆ†ä¸åŒçš„å¯¹è¯ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    thread_id çš„ä½œç”¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æƒ³è±¡ä¸€ä¸ªå®¢æœç³»ç»Ÿï¼ŒåŒæ—¶æœåŠ¡å¤šä¸ªç”¨æˆ·ï¼š                              â”‚
â”‚                                                                 â”‚
â”‚   ç”¨æˆ· A (thread_id: "user_a_session")                          â”‚
â”‚   â”œâ”€â”€ "æˆ‘è¦é€€è´§" â†’ AIè®°ä½                                        â”‚
â”‚   â””â”€â”€ "è®¢å•å·æ˜¯123" â†’ AIå…³è”åˆ°é€€è´§è¯·æ±‚                            â”‚
â”‚                                                                 â”‚
â”‚   ç”¨æˆ· B (thread_id: "user_b_session")                          â”‚
â”‚   â”œâ”€â”€ "æ¨èä¸€æ¬¾æ‰‹æœº" â†’ AIè®°ä½                                     â”‚
â”‚   â””â”€â”€ "é¢„ç®—3000" â†’ AIç»“åˆæ¨èéœ€æ±‚                                 â”‚
â”‚                                                                 â”‚
â”‚   ä¸¤ä¸ªç”¨æˆ·çš„å¯¹è¯å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ï¼                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### thread_id çš„å‘½åå»ºè®®

```javascript
// âœ… å¥½çš„ thread_id å‘½å
{
  thread_id: "user_12345";
} // ç”¨æˆ·ID
{
  thread_id: "session_abc123";
} // ä¼šè¯ID
{
  thread_id: "user_12345_chat_1";
} // ç”¨æˆ·ID + å¯¹è¯åºå·
{
  thread_id: "order_inquiry_67890";
} // ä¸šåŠ¡ç±»å‹ + ID

// âŒ ä¸å¥½çš„ thread_id å‘½å
{
  thread_id: "1";
} // å¤ªç®€å•ï¼Œå®¹æ˜“å†²çª
{
  thread_id: "test";
} // ä¸å…·ä½“
{
  thread_id: "";
} // ç©ºå­—ç¬¦ä¸²
```

### å¤šç”¨æˆ·åœºæ™¯ç¤ºä¾‹

```javascript
const memory = new MemorySaver();
const app = graph.compile({ checkpointer: memory });

// ç”¨æˆ· A çš„å¯¹è¯
async function chatWithUserA() {
  const config = { configurable: { thread_id: "user_a" } };

  await app.invoke({ messages: [new HumanMessage("æˆ‘æ˜¯ç”¨æˆ·A")] }, config);
  await app.invoke({ messages: [new HumanMessage("æˆ‘å–œæ¬¢Python")] }, config);

  // ç”¨æˆ· A çš„å¯¹è¯å†å²åªåŒ…å«ç”¨æˆ· A è¯´çš„è¯
}

// ç”¨æˆ· B çš„å¯¹è¯
async function chatWithUserB() {
  const config = { configurable: { thread_id: "user_b" } };

  await app.invoke({ messages: [new HumanMessage("æˆ‘æ˜¯ç”¨æˆ·B")] }, config);
  await app.invoke({ messages: [new HumanMessage("æˆ‘å–œæ¬¢Java")] }, config);

  // ç”¨æˆ· B çš„å¯¹è¯å†å²åªåŒ…å«ç”¨æˆ· B è¯´çš„è¯
}

// ä¸¤ä¸ªç”¨æˆ·çš„å¯¹è¯äº’ä¸å½±å“
await chatWithUserA();
await chatWithUserB();
```

---

# Part 6: å®æˆ˜æ¡ˆä¾‹

## æ¡ˆä¾‹ 1ï¼šå¤šè½®å¯¹è¯æœºå™¨äºº

### éœ€æ±‚åˆ†æ

æ„å»ºä¸€ä¸ªèƒ½å¤Ÿï¼š

1. è®°ä½ç”¨æˆ·åå­—
2. è®°ä½å¯¹è¯å†å²
3. åŸºäºä¸Šä¸‹æ–‡å›ç­”é—®é¢˜

### å®Œæ•´ä»£ç 

```javascript
import { StateGraph, Annotation, START, END } from "@langchain/langgraph";
import { MemorySaver } from "@langchain/langgraph";
import { ChatDeepSeek } from "@langchain/deepseek";
import {
  HumanMessage,
  AIMessage,
  SystemMessage,
} from "@langchain/core/messages";
import "dotenv/config";

// 1. åˆ›å»ºç»„ä»¶
const memory = new MemorySaver();
const llm = new ChatDeepSeek({ model: "deepseek-chat", temperature: 0.7 });

// 2. å®šä¹‰çŠ¶æ€
const ChatbotState = Annotation.Root({
  messages: Annotation({
    reducer: (prev, next) => [...prev, ...next],
    default: () => [],
  }),
});

// 3. å®šä¹‰èŠå¤©èŠ‚ç‚¹
async function chatNode(state) {
  // æ·»åŠ ç³»ç»Ÿæç¤ºï¼ˆè®© AI çŸ¥é“è¦è®°ä½ä¸Šä¸‹æ–‡ï¼‰
  const systemPrompt = new SystemMessage(
    "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ã€‚è¯·è®°ä½ç”¨æˆ·åœ¨å¯¹è¯ä¸­æåˆ°çš„ä¿¡æ¯ï¼ˆå¦‚åå­—ã€åå¥½ç­‰ï¼‰ï¼Œ" +
      "å¹¶åœ¨åç»­å¯¹è¯ä¸­è‡ªç„¶åœ°ä½¿ç”¨è¿™äº›ä¿¡æ¯ã€‚ä¿æŒå¯¹è¯è¿è´¯æ€§ã€‚"
  );

  // ç»„åˆæ¶ˆæ¯ï¼šç³»ç»Ÿæç¤º + å†å²æ¶ˆæ¯
  const messagesWithSystem = [systemPrompt, ...state.messages];

  const response = await llm.invoke(messagesWithSystem);
  return { messages: [response] };
}

// 4. æ„å»ºå›¾
const chatbot = new StateGraph(ChatbotState)
  .addNode("chat", chatNode)
  .addEdge(START, "chat")
  .addEdge("chat", END)
  .compile({ checkpointer: memory });

// 5. å¯¹è¯å‡½æ•°
async function chat(threadId, userMessage) {
  const config = { configurable: { thread_id: threadId } };

  const result = await chatbot.invoke(
    { messages: [new HumanMessage(userMessage)] },
    config
  );

  // è·å–æœ€åä¸€æ¡ AI å›å¤
  const aiResponse = result.messages[result.messages.length - 1];
  return aiResponse.content;
}

// 6. æµ‹è¯•å¤šè½®å¯¹è¯
async function main() {
  const threadId = "demo_conversation";

  console.log("ğŸ¤– å¼€å§‹å¤šè½®å¯¹è¯æ¼”ç¤º\n");
  console.log("=".repeat(50));

  // ç¬¬ä¸€è½®
  console.log("ğŸ‘¤ ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘å«å°æ˜");
  let response = await chat(threadId, "ä½ å¥½ï¼Œæˆ‘å«å°æ˜");
  console.log(`ğŸ¤– AI: ${response}\n`);

  // ç¬¬äºŒè½®
  console.log("ğŸ‘¤ ç”¨æˆ·: æˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œç‰¹åˆ«æ˜¯ JavaScript");
  response = await chat(threadId, "æˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œç‰¹åˆ«æ˜¯ JavaScript");
  console.log(`ğŸ¤– AI: ${response}\n`);

  // ç¬¬ä¸‰è½®ï¼ˆæµ‹è¯•è®°å¿†ï¼‰
  console.log("ğŸ‘¤ ç”¨æˆ·: æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿæˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ");
  response = await chat(threadId, "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿæˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ");
  console.log(`ğŸ¤– AI: ${response}\n`);

  console.log("=".repeat(50));
  console.log("âœ… æ¼”ç¤ºå®Œæˆï¼AI æˆåŠŸè®°ä½äº†ç”¨æˆ·ä¿¡æ¯ï¼");
}

main();
```

### æ‰§è¡Œæ•ˆæœ

```
ğŸ¤– å¼€å§‹å¤šè½®å¯¹è¯æ¼”ç¤º

==================================================
ğŸ‘¤ ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘å«å°æ˜
ğŸ¤– AI: ä½ å¥½å°æ˜ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ

ğŸ‘¤ ç”¨æˆ·: æˆ‘å–œæ¬¢ç¼–ç¨‹ï¼Œç‰¹åˆ«æ˜¯ JavaScript
ğŸ¤– AI: å¤ªæ£’äº†å°æ˜ï¼JavaScript æ˜¯ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œ
      ä½ æ˜¯åšå‰ç«¯å¼€å‘è¿˜æ˜¯å…¨æ ˆå¼€å‘å‘¢ï¼Ÿ

ğŸ‘¤ ç”¨æˆ·: æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿæˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ
ğŸ¤– AI: ä½ å«å°æ˜ï¼Œä½ å–œæ¬¢ç¼–ç¨‹ï¼Œç‰¹åˆ«æ˜¯ JavaScriptï¼

==================================================
âœ… æ¼”ç¤ºå®Œæˆï¼AI æˆåŠŸè®°ä½äº†ç”¨æˆ·ä¿¡æ¯ï¼
```

---

## æ¡ˆä¾‹ 2ï¼šå¸¦è®°å¿†çš„ Agent

### éœ€æ±‚åˆ†æ

æ„å»ºä¸€ä¸ªèƒ½å¤Ÿï¼š

1. è®°ä½å¯¹è¯å†å²
2. ä½¿ç”¨å·¥å…·ï¼ˆè®¡ç®—å™¨ã€å¤©æ°”æŸ¥è¯¢ï¼‰
3. å¤šè½®äº¤äº’å®Œæˆå¤æ‚ä»»åŠ¡

### æ ¸å¿ƒä»£ç ç»“æ„

```javascript
import { StateGraph, Annotation, START, END } from "@langchain/langgraph";
import { MemorySaver } from "@langchain/langgraph";
import { ToolNode } from "@langchain/langgraph/prebuilt";
import { ChatDeepSeek } from "@langchain/deepseek";
import { DynamicStructuredTool } from "@langchain/core/tools";
import { HumanMessage } from "@langchain/core/messages";
import { z } from "zod";
import "dotenv/config";

// 1. åˆ›å»ºè®°å¿†å­˜å‚¨
const memory = new MemorySaver();

// 2. å®šä¹‰å·¥å…·
const tools = [
  new DynamicStructuredTool({
    name: "calculator",
    description: "æ•°å­¦è®¡ç®—",
    schema: z.object({ expression: z.string() }),
    func: async ({ expression }) => {
      return String(eval(expression)); // æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒéœ€è¦å®‰å…¨å¤„ç†
    },
  }),
  // ... å…¶ä»–å·¥å…·
];

// 3. ç»‘å®šå·¥å…·åˆ° LLM
const llm = new ChatDeepSeek({ model: "deepseek-chat", temperature: 0 });
const llmWithTools = llm.bindTools(tools);

// 4. å®šä¹‰çŠ¶æ€
const AgentState = Annotation.Root({
  messages: Annotation({
    reducer: (prev, next) => [...prev, ...next],
    default: () => [],
  }),
});

// 5. å®šä¹‰èŠ‚ç‚¹
async function agentNode(state) {
  const response = await llmWithTools.invoke(state.messages);
  return { messages: [response] };
}

const toolNode = new ToolNode(tools);

// 6. è·¯ç”±å‡½æ•°
function shouldCallTools(state) {
  const lastMessage = state.messages[state.messages.length - 1];
  return lastMessage.tool_calls?.length > 0 ? "tools" : "end";
}

// 7. æ„å»ºå›¾å¹¶æ·»åŠ è®°å¿†
const agent = new StateGraph(AgentState)
  .addNode("agent", agentNode)
  .addNode("tools", toolNode)
  .addEdge(START, "agent")
  .addConditionalEdges("agent", shouldCallTools, {
    tools: "tools",
    end: END,
  })
  .addEdge("tools", "agent")
  .compile({ checkpointer: memory }); // å…³é”®ï¼šæ·»åŠ è®°å¿†ï¼

// 8. ä½¿ç”¨
const config = { configurable: { thread_id: "agent_session_1" } };

// ç¬¬ä¸€è½®ï¼šè®¡ç®—
await agent.invoke(
  { messages: [new HumanMessage("å¸®æˆ‘è®¡ç®— 100 * 5")] },
  config
);

// ç¬¬äºŒè½®ï¼šåŸºäºä¸Šä¸‹æ–‡ç»§ç»­ï¼ˆè®°å¾—ä¸Šæ¬¡ç®—äº† 500ï¼‰
await agent.invoke({ messages: [new HumanMessage("å†ä¹˜ä»¥ 2")] }, config);
```

### è®°å¿†åœ¨ Agent ä¸­çš„ä½œç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å¸¦è®°å¿†çš„ Agent æ‰§è¡Œæµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç¬¬ä¸€è½®å¯¹è¯ (thread_id: "session_1")                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚  ç”¨æˆ·: "å¸®æˆ‘è®¡ç®— 100 * 5"                                        â”‚
â”‚    â†“                                                            â”‚
â”‚  Agent å†³å®šè°ƒç”¨ calculator                                       â”‚
â”‚    â†“                                                            â”‚
â”‚  Tool è¿”å›: "500"                                                â”‚
â”‚    â†“                                                            â”‚
â”‚  AI å›å¤: "100 Ã— 5 = 500"                                        â”‚
â”‚    â†“                                                            â”‚
â”‚  ğŸ’¾ ä¿å­˜åˆ° memoryï¼ˆåŒ…å«å®Œæ•´å¯¹è¯ï¼‰                                 â”‚
â”‚                                                                 â”‚
â”‚  ç¬¬äºŒè½®å¯¹è¯ (åŒä¸€ä¸ª thread_id)                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”‚
â”‚  ç”¨æˆ·: "å†ä¹˜ä»¥ 2"                                                 â”‚
â”‚    â†“                                                            â”‚
â”‚  ğŸ“– ä» memory è¯»å–å†å²ï¼ˆçŸ¥é“ä¸Šæ¬¡ç®—äº† 500ï¼‰                        â”‚
â”‚    â†“                                                            â”‚
â”‚  Agent ç†è§£ä¸Šä¸‹æ–‡ï¼Œè°ƒç”¨ calculator("500 * 2")                    â”‚
â”‚    â†“                                                            â”‚
â”‚  AI å›å¤: "500 Ã— 2 = 1000"                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¡ˆä¾‹ 3ï¼šæ™ºèƒ½å®¢æœ Agent

### åœºæ™¯

ç”µå•†å®¢æœï¼Œèƒ½æŸ¥è¯¢è®¢å•ã€å¤„ç†é€€æ¬¾

```javascript
// è®¢å•æŸ¥è¯¢å·¥å…·
const orderTool = new DynamicStructuredTool({
  name: "query_order",
  description: "æŸ¥è¯¢è®¢å•çŠ¶æ€",
  schema: z.object({
    order_id: z.string().describe("è®¢å•å·"),
  }),
  func: async ({ order_id }) => {
    // è°ƒç”¨è®¢å•ç³»ç»Ÿ
    return JSON.stringify({
      order_id,
      status: "å·²å‘è´§",
      shipping: "é¡ºä¸°å¿«é€’",
      expected: "æ˜å¤©é€è¾¾",
    });
  },
});

// é€€æ¬¾ç”³è¯·å·¥å…·
const refundTool = new DynamicStructuredTool({
  name: "request_refund",
  description: "ç”³è¯·é€€æ¬¾",
  schema: z.object({
    order_id: z.string(),
    reason: z.string(),
  }),
  func: async ({ order_id, reason }) => {
    // è°ƒç”¨é€€æ¬¾ç³»ç»Ÿ
    return JSON.stringify({
      refund_id: "RF" + Date.now(),
      status: "å®¡æ ¸ä¸­",
      message: "é€€æ¬¾ç”³è¯·å·²æäº¤ï¼Œé¢„è®¡1-3ä¸ªå·¥ä½œæ—¥å¤„ç†",
    });
  },
});

// æ„å»ºå®¢æœ Agent
const customerServiceAgent = new StateGraph(AgentState)
  .addNode("agent", agentNode)
  .addNode("tools", new ToolNode([orderTool, refundTool]))
  // ... å…¶ä»–é…ç½®
  .compile({ checkpointer: memory });
```

### å¯¹è¯ç¤ºä¾‹

```
ç”¨æˆ·ï¼šæˆ‘çš„è®¢å• 12345 ä»€ä¹ˆæ—¶å€™åˆ°ï¼Ÿ

Agent:
[æ€è€ƒ] ç”¨æˆ·æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œéœ€è¦è°ƒç”¨è®¢å•æŸ¥è¯¢å·¥å…·
[è¡ŒåŠ¨] query_order(order_id="12345")
[è§‚å¯Ÿ] {"status":"å·²å‘è´§","shipping":"é¡ºä¸°","expected":"æ˜å¤©é€è¾¾"}
[å›ç­”] æ‚¨çš„è®¢å• 12345 å·²ç»å‘è´§å•¦ï¼ç”±é¡ºä¸°å¿«é€’é…é€ï¼Œé¢„è®¡æ˜å¤©é€è¾¾ã€‚
       è¯·ä¿æŒæ‰‹æœºç•…é€šï¼Œå¿«é€’å°å“¥ä¼šæå‰è”ç³»æ‚¨~
```

---

# Part 7: æœ€ä½³å®è·µ

## âœ… 1. å·¥å…·è®¾è®¡åŸåˆ™

```javascript
// âœ… å¥½çš„å·¥å…·è®¾è®¡
const goodTool = {
  // åç§°ï¼šç®€æ´ã€æè¿°æ€§
  name: "search_products",

  // æè¿°ï¼šè¯¦ç»†ã€åŒ…å«ä½¿ç”¨åœºæ™¯
  description:
    "æœç´¢å•†å“ä¿¡æ¯ã€‚" +
    "å½“ç”¨æˆ·è¯¢é—®å•†å“ä»·æ ¼ã€åº“å­˜ã€è§„æ ¼æ—¶ä½¿ç”¨ã€‚" +
    "è¿”å›å•†å“åç§°ã€ä»·æ ¼ã€åº“å­˜æ•°é‡ã€‚",

  // å‚æ•°ï¼šæ¯ä¸ªéƒ½æœ‰æ¸…æ™°çš„ describe
  schema: z.object({
    keyword: z.string().describe("æœç´¢å…³é”®è¯ï¼Œå¦‚å•†å“åç§°"),
    category: z.string().optional().describe("å•†å“ç±»åˆ«ï¼Œå¦‚'ç”µå­äº§å“'"),
    max_results: z.number().optional().describe("æœ€å¤§è¿”å›æ•°é‡ï¼Œé»˜è®¤10"),
  }),

  // è¿”å›ï¼šç»“æ„åŒ– JSON
  func: async (params) => {
    const results = await searchProducts(params);
    return JSON.stringify(results);
  },
};
```

## âœ… 2. æ§åˆ¶ Agent è¡Œä¸º

```javascript
// ä½¿ç”¨ SystemMessage è®¾å®š Agent äººè®¾å’Œè¡Œä¸ºè§„èŒƒ
const messages = [
  new SystemMessage(`
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ã€‚

è§„åˆ™ï¼š
1. å§‹ç»ˆä¿æŒç¤¼è²Œå’Œä¸“ä¸š
2. å¦‚æœä¸ç¡®å®šï¼Œè¯·ä½¿ç”¨æœç´¢å·¥å…·æŸ¥è¯¢
3. æ¶‰åŠé€€æ¬¾ç­‰æ•æ„Ÿæ“ä½œï¼Œå…ˆç¡®è®¤ç”¨æˆ·èº«ä»½
4. å¦‚æœé—®é¢˜è¶…å‡ºèƒ½åŠ›èŒƒå›´ï¼Œå»ºè®®è½¬äººå·¥å®¢æœ
  `),
  new HumanMessage(userQuestion),
];
```

## âœ… 3. é™åˆ¶å’Œå…œåº•

```javascript
// è®¾ç½®åˆç†çš„é™åˆ¶
const agent = graph.compile({
  checkpointer: memory,
  recursionLimit: 15, // æœ€å¤§å¾ªç¯æ¬¡æ•°
});

// è¶…æ—¶å¤„ç†
const result = await Promise.race([
  agent.invoke(input),
  new Promise((_, reject) =>
    setTimeout(() => reject(new Error("è¶…æ—¶")), 30000)
  ),
]);
```

## âœ… 4. æ¶ˆæ¯çŠ¶æ€ä½¿ç”¨ç´¯åŠ  reducer

```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç´¯åŠ  reducer
messages: Annotation({
  reducer: (prev, next) => [...prev, ...next],  // ç´¯åŠ 
  default: () => [],
}),

// âŒ é”™è¯¯ï¼šä½¿ç”¨æ›¿æ¢ reducerï¼ˆä¼šä¸¢å¤±å†å²ï¼‰
messages: Annotation({
  reducer: (prev, next) => next,  // æ›¿æ¢
  default: () => [],
}),
```

## âœ… 5. é™åˆ¶æ¶ˆæ¯å†å²é•¿åº¦

```javascript
// å½“æ¶ˆæ¯è¿‡å¤šæ—¶ï¼Œå¯èƒ½è¶…å‡º LLM ä¸Šä¸‹æ–‡é™åˆ¶
// è§£å†³æ–¹æ¡ˆï¼šåœ¨èŠ‚ç‚¹ä¸­è£å‰ªå†å²
async function chatNode(state) {
  // åªä¿ç•™æœ€è¿‘ 20 æ¡æ¶ˆæ¯
  const recentMessages = state.messages.slice(-20);

  const response = await llm.invoke(recentMessages);
  return { messages: [response] };
}
```

## âœ… 6. æ—¥å¿—å’Œç›‘æ§

```javascript
// è®°å½• Agent çš„æ¯ä¸€æ­¥æ“ä½œ
async function agentNodeWithLogging(state) {
  const startTime = Date.now();

  console.log(`[${new Date().toISOString()}] Agent å¼€å§‹æ€è€ƒ`);
  console.log(`è¾“å…¥æ¶ˆæ¯æ•°: ${state.messages.length}`);

  const response = await llmWithTools.invoke(state.messages);

  console.log(`è€—æ—¶: ${Date.now() - startTime}ms`);
  console.log(`æ˜¯å¦è°ƒç”¨å·¥å…·: ${response.tool_calls?.length > 0}`);

  return { messages: [response] };
}
```

---

# Part 8: å¸¸è§é—®é¢˜ FAQ

## Q1: Agent é™·å…¥æ­»å¾ªç¯æ€ä¹ˆåŠï¼Ÿ

**é—®é¢˜**ï¼šAgent ä¸æ–­è°ƒç”¨å·¥å…·ï¼Œæ— æ³•åœæ­¢

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// æ–¹æ³• 1ï¼šé™åˆ¶æœ€å¤§è¿­ä»£æ¬¡æ•°
const agent = graph.compile({
  recursionLimit: 10, // æœ€å¤š 10 æ¬¡å¾ªç¯
});

// æ–¹æ³• 2ï¼šåœ¨è·¯ç”±å‡½æ•°ä¸­æ£€æŸ¥
function shouldCallTools(state) {
  if (state.messages.length > 20) {
    console.log("è­¦å‘Šï¼šè¾¾åˆ°æœ€å¤§æ¶ˆæ¯æ•°ï¼Œå¼ºåˆ¶ç»“æŸ");
    return "end";
  }
  // ... æ­£å¸¸é€»è¾‘
}
```

## Q2: Agent é€‰é”™äº†å·¥å…·æ€ä¹ˆåŠï¼Ÿ

**é—®é¢˜**ï¼šAgent è°ƒç”¨äº†ä¸ç›¸å…³çš„å·¥å…·

**è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// 1. ä¼˜åŒ–å·¥å…·æè¿°
const weatherTool = {
  name: "get_weather",
  // âŒ ä¸å¥½çš„æè¿°
  description: "æŸ¥è¯¢å¤©æ°”",

  // âœ… å¥½çš„æè¿°
  description:
    "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€é£åŠ›ç­‰ã€‚" +
    "å½“ç”¨æˆ·è¯¢é—®å¤©æ°”ã€æ¸©åº¦ã€æ˜¯å¦ä¸‹é›¨ã€æ˜¯å¦éœ€è¦å¸¦ä¼æ—¶ä½¿ç”¨æ­¤å·¥å…·ã€‚",
};

// 2. ä½¿ç”¨ SystemMessage ç»™ Agent æ˜ç¡®æŒ‡ä»¤
const messages = [
  new SystemMessage(
    "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚è¯·ä»”ç»†åˆ†æç”¨æˆ·é—®é¢˜ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å·¥å…·ã€‚" +
      "å¦‚æœé—®é¢˜ä¸éœ€è¦å·¥å…·ï¼Œç›´æ¥å›ç­”å³å¯ã€‚"
  ),
  new HumanMessage("ç”¨æˆ·é—®é¢˜..."),
];
```

## Q3: å¦‚ä½•è°ƒè¯• Agentï¼Ÿ

```javascript
// 1. åœ¨èŠ‚ç‚¹ä¸­æ·»åŠ æ—¥å¿—
async function agentNode(state) {
  console.log("=== Agent èŠ‚ç‚¹ ===");
  console.log("å½“å‰æ¶ˆæ¯æ•°:", state.messages.length);
  console.log("æœ€åä¸€æ¡æ¶ˆæ¯:", state.messages.slice(-1));

  const response = await llmWithTools.invoke(state.messages);

  console.log("LLM è¿”å›:", response);
  console.log("tool_calls:", response.tool_calls);

  return { messages: [response] };
}

// 2. ä½¿ç”¨ LangGraph çš„æµå¼è¾“å‡ºæŸ¥çœ‹ä¸­é—´çŠ¶æ€
const stream = await agent.stream({
  messages: [new HumanMessage("é—®é¢˜")],
});

for await (const chunk of stream) {
  console.log("Chunk:", JSON.stringify(chunk, null, 2));
}
```

## Q4: ä¸ºä»€ä¹ˆ AI æ²¡æœ‰è®°ä½æˆ‘è¯´çš„è¯ï¼Ÿ

**å¯èƒ½åŸå› ï¼š**

1. **æ²¡æœ‰æ·»åŠ  checkpointer**

```javascript
// âŒ å¿˜è®°æ·»åŠ  checkpointer
const app = graph.compile();

// âœ… æ­£ç¡®
const app = graph.compile({ checkpointer: memory });
```

2. **thread_id ä¸ä¸€è‡´**

```javascript
// âŒ æ¯æ¬¡ç”¨ä¸åŒçš„ thread_id
await app.invoke(input, { configurable: { thread_id: "thread_1" } });
await app.invoke(input, { configurable: { thread_id: "thread_2" } }); // æ–°çº¿ç¨‹ï¼

// âœ… ä½¿ç”¨ç›¸åŒçš„ thread_id
const threadId = "my_conversation";
await app.invoke(input, { configurable: { thread_id: threadId } });
await app.invoke(input, { configurable: { thread_id: threadId } });
```

3. **æ¶ˆæ¯ reducer è®¾ç½®é”™è¯¯**

```javascript
// âŒ ä½¿ç”¨æ›¿æ¢ reducer
reducer: (prev, next) => next; // æ¯æ¬¡éƒ½æ›¿æ¢ï¼Œä¸¢å¤±å†å²

// âœ… ä½¿ç”¨ç´¯åŠ  reducer
reducer: (prev, next) => [...prev, ...next]; // ä¿ç•™å†å²
```

## Q5: ç¨‹åºé‡å¯åè®°å¿†ä¸¢å¤±äº†ï¼Ÿ

**è§£ç­”**ï¼šMemorySaver å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œç¨‹åºç»“æŸåæ•°æ®å°±æ²¡äº†ã€‚å¦‚éœ€æŒä¹…åŒ–ï¼Œè¯·ä½¿ç”¨ SqliteSaver æˆ–å…¶ä»–æŒä¹…åŒ– Checkpointerã€‚

### å¸¸è§ Checkpointer å¯¹æ¯”

| ç±»å‹              | å­˜å‚¨ä½ç½®    | æŒä¹…åŒ– | é€‚ç”¨åœºæ™¯   |
| ----------------- | ----------- | ------ | ---------- |
| **MemorySaver**   | å†…å­˜        | âŒ     | å¼€å‘æµ‹è¯•   |
| **SqliteSaver**   | SQLite æ–‡ä»¶ | âœ…     | æœ¬åœ°åº”ç”¨   |
| **PostgresSaver** | PostgreSQL  | âœ…     | ç”Ÿäº§ç¯å¢ƒ   |
| **RedisSaver**    | Redis       | âœ…     | é«˜æ€§èƒ½åœºæ™¯ |
| **MongoSaver**    | MongoDB     | âœ…     | æ–‡æ¡£å‹å­˜å‚¨ |

## Q6: å¤šä¸ªç”¨æˆ·ä¼šå…±äº«è®°å¿†å—ï¼Ÿ

**ä¸ä¼š**ï¼Œåªè¦ä½¿ç”¨ä¸åŒçš„ thread_idï¼Œæ¯ä¸ªç”¨æˆ·çš„å¯¹è¯æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚

```javascript
// ç”¨æˆ· A å’Œç”¨æˆ· B ä½¿ç”¨ä¸åŒçš„ thread_id
const userAConfig = { configurable: { thread_id: "user_a" } };
const userBConfig = { configurable: { thread_id: "user_b" } };
// ä¸¤è€…çš„å¯¹è¯å†å²äº’ä¸å½±å“
```

---

# Part 9: è¿›é˜¶ä¸»é¢˜

## 1. å¤š Agent åä½œ

```javascript
// ä¸» Agent è°ƒåº¦å¤šä¸ªå­ Agent
const researchAgent = buildResearchAgent();
const writerAgent = buildWriterAgent();
const reviewerAgent = buildReviewerAgent();

// å·¥ä½œæµï¼šç ”ç©¶ â†’ å†™ä½œ â†’ å®¡æ ¸
const workflow = new StateGraph(State)
  .addNode("research", researchAgent)
  .addNode("write", writerAgent)
  .addNode("review", reviewerAgent)
  .addEdge(START, "research")
  .addEdge("research", "write")
  .addEdge("write", "review")
  .addEdge("review", END);
```

## 2. äººå·¥ä»‹å…¥ï¼ˆHuman-in-the-Loopï¼‰

```javascript
// åœ¨å…³é”®æ­¥éª¤ç­‰å¾…äººå·¥ç¡®è®¤
const graph = new StateGraph(AgentState)
  .addNode("agent", agentNode)
  .addNode("tools", toolNode)
  .addNode("human_review", async (state) => {
    // ç­‰å¾…äººå·¥ç¡®è®¤
    console.log("è¯·ç¡®è®¤æ˜¯å¦æ‰§è¡Œä»¥ä¸‹æ“ä½œ...");
    // å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥
    return { messages: [new HumanMessage("å·²ç¡®è®¤")] };
  })
  .addConditionalEdges(
    "agent",
    (state) => {
      // æ•æ„Ÿæ“ä½œéœ€è¦äººå·¥ç¡®è®¤
      const last = state.messages.slice(-1)[0];
      if (isSensitiveOperation(last.tool_calls)) {
        return "human_review";
      }
      return "tools";
    },
    {
      human_review: "human_review",
      tools: "tools",
      end: END,
    }
  );
```

## 3. é”™è¯¯æ¢å¤

```javascript
// å·¥å…·å¤±è´¥æ—¶çš„å¤„ç†
async function toolNodeWithRetry(state) {
  const toolNode = new ToolNode(tools);

  try {
    return await toolNode.invoke(state);
  } catch (error) {
    console.log("å·¥å…·è°ƒç”¨å¤±è´¥ï¼Œå°è¯•é‡è¯•...");

    // è¿”å›é”™è¯¯ä¿¡æ¯ç»™ Agentï¼Œè®©å®ƒå†³å®šä¸‹ä¸€æ­¥
    return {
      messages: [
        new ToolMessage({
          content: `å·¥å…·è°ƒç”¨å¤±è´¥: ${error.message}ã€‚è¯·å°è¯•å…¶ä»–æ–¹æ³•ã€‚`,
          tool_call_id: state.messages.slice(-1)[0].tool_calls[0].id,
        }),
      ],
    };
  }
}
```

## 4. å¹¶è¡Œå·¥å…·è°ƒç”¨

```javascript
// LangGraph çš„ ToolNode è‡ªåŠ¨æ”¯æŒå¹¶è¡Œè°ƒç”¨
// å½“ AI è¿”å›å¤šä¸ª tool_calls æ—¶ï¼Œä¼šå¹¶è¡Œæ‰§è¡Œ

// AI è¿”å›ï¼š
{
  tool_calls: [
    { name: "get_weather", args: { city: "åŒ—äº¬" } },
    { name: "get_weather", args: { city: "ä¸Šæµ·" } },
    { name: "get_time", args: {} },
  ];
}

// ToolNode ä¼šå¹¶è¡Œæ‰§è¡Œè¿™ 3 ä¸ªå·¥å…·è°ƒç”¨
```

## 5. çŠ¶æ€æŸ¥çœ‹ä¸è°ƒè¯•

```javascript
// ä½¿ç”¨ getState æ–¹æ³•æŸ¥çœ‹å½“å‰çŠ¶æ€
const state = await app.getState({ configurable: { thread_id: "my_thread" } });

console.log("å½“å‰çŠ¶æ€:", state.values);
console.log("æ¶ˆæ¯æ•°é‡:", state.values.messages.length);

// è·å–æ‰€æœ‰å†å²çŠ¶æ€ï¼ˆæ£€æŸ¥ç‚¹ï¼‰
const history = app.getStateHistory({
  configurable: { thread_id: "my_thread" },
});

for await (const checkpoint of history) {
  console.log("æ—¶é—´:", checkpoint.createdAt);
  console.log("æ¶ˆæ¯æ•°:", checkpoint.values.messages.length);
  console.log("---");
}
```

---

# æ€»ç»“

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹

1. **LangChain vs LangGraph**

   - LangChain æä¾›åŸºç¡€ç»„ä»¶ï¼ˆLLMã€Toolsã€Promptï¼‰
   - LangGraph æä¾›ç¼–æ’èƒ½åŠ›ï¼ˆå¾ªç¯ã€åˆ†æ”¯ã€çŠ¶æ€ç®¡ç†ï¼‰
   - æ„å»ºå¤æ‚ Agent æ¨èä½¿ç”¨ LangGraph

2. **Agent = LLM + Tools + è‡ªä¸»å†³ç­–**

   - LLM è´Ÿè´£æ€è€ƒå’Œæ¨ç†
   - Tools æä¾›æ‰§è¡Œèƒ½åŠ›
   - å¾ªç¯æœºåˆ¶å®ç°è‡ªä¸»å†³ç­–

3. **ReAct æ¨¡å¼æ˜¯ Agent çš„æ ¸å¿ƒ**

   - Thought â†’ Action â†’ Observation â†’ Thought...
   - å¾ªç¯ç›´åˆ°å®Œæˆä»»åŠ¡

4. **MemorySaver è®© Agent æ‹¥æœ‰è®°å¿†**

   - checkpointer ä¿å­˜å¯¹è¯çŠ¶æ€
   - thread_id åŒºåˆ†ä¸åŒå¯¹è¯
   - æ¶ˆæ¯ä½¿ç”¨ç´¯åŠ  reducer

5. **å·¥å…·è®¾è®¡å†³å®š Agent èƒ½åŠ›**
   - æ¸…æ™°çš„æè¿°
   - åˆç†çš„å‚æ•°
   - ç¨³å®šçš„è¿”å›æ ¼å¼

## ğŸ’¡ è®°ä½è¿™å¥è¯

> **Agent çš„å¼ºå¤§ä¸åœ¨äºå®ƒæœ‰å¤šèªæ˜ï¼Œè€Œåœ¨äºå®ƒèƒ½ç”¨å·¥å…·åšå¤šå°‘äº‹ã€‚**

å·¥å…·è¶Šä¸°å¯Œã€è¶Šå¯é ï¼ŒAgent çš„èƒ½åŠ›å°±è¶Šå¼ºã€‚

---

## å­¦ä¹ è·¯å¾„å»ºè®®

### ğŸ“ é…å¥—å®æˆ˜æ–‡ä»¶

> ğŸ”— ä»“åº“åœ°å€ï¼š[https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning](https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning)

| æ–‡ä»¶                                 | å†…å®¹             | é¢„è®¡ç”¨æ—¶ | GitHub é“¾æ¥                                                                                                             |
| ------------------------------------ | ---------------- | -------- | ----------------------------------------------------------------------------------------------------------------------- |
| `src/agent.js`                       | Agent å…¥é—¨ Demo  | 30 åˆ†é’Ÿ  | [ğŸ“„ æŸ¥çœ‹ä»£ç ](https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning/src/agent.js)                       |
| `src/langgraph/06-react-agent.js`    | ReAct Agent è¯¦è§£ | 30 åˆ†é’Ÿ  | [ğŸ“„ æŸ¥çœ‹ä»£ç ](https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning/src/langgraph/06-react-agent.js)    |
| `src/langgraph/07-memory-basic.js`   | MemorySaver åŸºç¡€ | 20 åˆ†é’Ÿ  | [ğŸ“„ æŸ¥çœ‹ä»£ç ](https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning/src/langgraph/07-memory-basic.js)   |
| `src/langgraph/08-memory-chatbot.js` | å¤šè½®å¯¹è¯æœºå™¨äºº   | 30 åˆ†é’Ÿ  | [ğŸ“„ æŸ¥çœ‹ä»£ç ](https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning/src/langgraph/08-memory-chatbot.js) |
| `src/langgraph/09-memory-agent.js`   | å¸¦è®°å¿†çš„ Agent   | 30 åˆ†é’Ÿ  | [ğŸ“„ æŸ¥çœ‹ä»£ç ](https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning/src/langgraph/09-memory-agent.js)   |
| `src/tools-demo.js`                  | Tools ä½¿ç”¨è¯¦è§£   | 20 åˆ†é’Ÿ  | [ğŸ“„ æŸ¥çœ‹ä»£ç ](https://github.com/Lidh1023/nodejs-basic/tree/main/langchain-learning/src/tools-demo.js)                  |

### ğŸ¯ å­¦ä¹ è·¯çº¿

**é˜¶æ®µ 1ï¼šç†è§£æ¦‚å¿µï¼ˆ1 å°æ—¶ï¼‰**

1. âœ… é˜…è¯»æœ¬æ–‡æ¡£ï¼Œç†è§£ Agentã€ReActã€MemorySaver çš„æ¦‚å¿µ
2. âœ… è¿è¡Œ `src/agent.js`ï¼Œè§‚å¯Ÿ Agent çš„å·¥ä½œè¿‡ç¨‹
3. âœ… å°è¯•ä¿®æ”¹é—®é¢˜ï¼Œè§‚å¯Ÿ Agent çš„ä¸åŒè¡Œä¸º

**é˜¶æ®µ 2ï¼šåŠ¨æ‰‹å®è·µï¼ˆ2 å°æ—¶ï¼‰**

1. ğŸ”¥ æ·»åŠ æ–°çš„å·¥å…·ï¼ˆå¦‚ç¿»è¯‘ã€æ•°æ®åº“æŸ¥è¯¢ï¼‰
2. ğŸ”¥ å®ç°ä¸€ä¸ªç‰¹å®šåœºæ™¯çš„ Agentï¼ˆå¦‚å®¢æœã€åŠ©æ‰‹ï¼‰
3. ğŸ”¥ å°è¯•å¤„ç†å¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡

**é˜¶æ®µ 3ï¼šè¿›é˜¶æŒæ¡ï¼ˆ3+ å°æ—¶ï¼‰**

1. ğŸ’ å­¦ä¹  MemorySaver å®ç°å¯¹è¯è®°å¿†
2. ğŸ’ å®ç°äººå·¥ä»‹å…¥çš„å®¡æ ¸æµç¨‹
3. ğŸ’ æ¢ç´¢å¤š Agent åä½œ

---

## å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- **LangGraph å®˜æ–¹æ–‡æ¡£**: https://langchain-ai.github.io/langgraphjs/
- **LangChain Tools æ–‡æ¡£**: https://js.langchain.com/docs/concepts/tools/
- **ReAct è®ºæ–‡**: https://arxiv.org/abs/2210.03629

### ç›¸å…³æ–‡ç« 

- ã€ŠReAct: Synergizing Reasoning and Acting in Language Modelsã€‹
- ã€ŠTool Learning with Foundation Modelsã€‹

---

## ä½œè€…å¯„è¯­

Agent æ˜¯ AI åº”ç”¨çš„æœªæ¥ã€‚ç†è§£äº† Agentï¼Œä½ å°±æŒæ¡äº†è®© AI "åšäº‹"è€Œä¸ä»…ä»…æ˜¯"è¯´è¯"çš„èƒ½åŠ›ã€‚

ä»ç®€å•çš„ ReAct Agent å¼€å§‹ï¼Œé€æ­¥æ¢ç´¢æ›´å¤æ‚çš„åœºæ™¯ã€‚è®°ä½ï¼š

- **å…ˆç†è§£åŸç†ï¼Œå†å †åŠŸèƒ½**
- **ä»ç®€å•åœºæ™¯å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦**
- **å¤šè°ƒè¯•ã€å¤šè§‚å¯Ÿ Agent çš„è¡Œä¸º**

å¦‚æœä½ å®Œæˆäº†æœ¬æ•™ç¨‹çš„æ‰€æœ‰ç»ƒä¹ ï¼Œæ­å–œä½ ï¼ä½ å·²ç»å…·å¤‡äº†æ„å»ºç”Ÿäº§çº§ AI Agent çš„åŸºç¡€èƒ½åŠ›ã€‚

**Happy Coding!** ğŸš€

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**: å…ˆç†è§£ LangChain å’Œ LangGraph çš„å…³ç³»ï¼Œå†ä»ç®€å•çš„ Agent å¼€å§‹ï¼Œé€æ­¥æ·»åŠ è®°å¿†åŠŸèƒ½ã€‚æ¯ä¸€æ­¥éƒ½è§‚å¯Ÿ AI æ˜¯å¦‚ä½•"æ€è€ƒ"å’Œ"è¡ŒåŠ¨"çš„ï¼
